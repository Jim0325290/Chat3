<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>ğŸ“ 2å°2 è¦–è¨ŠèŠå¤©</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#007aff">
<style>
html, body { margin:0; padding:0; height:100%; font-family:Arial; }
#container { display:flex; flex-direction:column; height:100%; }
#tip { background:#fffae6; padding:10px; border:1px solid #ccc; margin:0; }
#loginDiv, #roomDiv { padding:10px; background:#f0f0f0; }
#mainArea { display:flex; flex-direction:column; flex:1; }
#videoContainer { flex:1; }
#chatRoom { width:100%; height:100%; border:none; }
#chatArea { height:30%; overflow-y:auto; border-top:1px solid #ccc; padding:5px; background:#f9f9f9; }
#roomList div { margin:5px 0; }
#stickerPanel img { width:40px; margin:5px; cursor:pointer; }
#fullscreenBtn { margin:5px; padding:5px 10px; cursor:pointer; }
@media (max-width:768px){ #chatArea{ height:35%; } }
</style>
</head>
<body>
<h1>ğŸ“ 2å°2 è¦–è¨ŠèŠå¤©</h1>
<div id="tip">æ­¥é©Ÿï¼šè¼¸å…¥å¸³è™Ÿå¯†ç¢¼ + ä¸­æ–‡åå­— â†’ å»ºç«‹æˆ–åŠ å…¥æˆ¿é–“ â†’ å…è¨±åŠ å…¥ â†’ é–‹å§‹èŠå¤©</div>

<div id="loginDiv">
  <label>å¸³è™Ÿï¼š</label><input type="text" id="account"><br><br>
  <label>å¯†ç¢¼ï¼š</label><input type="password" id="password"><br><br>
  <label>ä¸­æ–‡åå­—ï¼š</label><input type="text" id="name"><br><br>
  <button onclick="login()">ç™»å…¥</button>
</div>

<div id="roomDiv" style="display:none;">
  <h2>æˆ¿é–“</h2>
  <input type="text" id="roomName" placeholder="è¼¸å…¥æˆ¿é–“åç¨±">
  <button onclick="createRoom()">å‰µå»ºæˆ¿é–“</button>
  <button onclick="joinRoom()">åŠ å…¥æˆ¿é–“</button>
  <button onclick="callFriend()">æ‰“çµ¦æœ‹å‹</button>
  <h3>æˆ‘åŠ å…¥éçš„æˆ¿é–“ï¼š</h3>
  <div id="roomList"></div>
</div>

<div id="inviteDiv" style="margin-top:5px;"></div>

<div id="mainArea">
  <button id="fullscreenBtn" onclick="toggleFullscreen()">å…¨è¢å¹•</button>
  <div id="videoContainer">
    <iframe id="chatRoom"></iframe>
  </div>
  <div id="chatArea" style="display:none;">
    <h3>èŠå¤©å®¤</h3>
    <div id="messages"></div>
    <input type="text" id="chatInput" placeholder="è¼¸å…¥è¨Šæ¯">
    <button onclick="sendMessage()">é€å‡º</button>
    <button onclick="toggleStickers()">è²¼åœ–</button>
    <div id="stickerPanel" style="display:none;">
      <img src="sticker1.png" onclick="sendSticker('sticker1.png')">
      <img src="sticker2.png" onclick="sendSticker('sticker2.png')">
      <img src="sticker3.png" onclick="sendSticker('sticker3.png')">
    </div>
  </div>
</div>

<script>
// Service Worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js')
    .then(()=>console.log('Service Worker è¨»å†ŠæˆåŠŸ'))
    .catch(e=>console.log('Service Worker è¨»å†Šå¤±æ•—', e));
}

const USER_ACCOUNTS = { "hhhzv522":"Ai20150325." };
let invitedRoom = null;
let isFullscreen = false;

window.onload = function(){
  const params = new URLSearchParams(window.location.search);
  if(params.has("room")){
    invitedRoom = params.get("room");
    document.getElementById('roomName').value = invitedRoom;
    alert("å·²åµæ¸¬åˆ°é‚€è«‹æˆ¿é–“ï¼š" + invitedRoom + "ï¼Œç™»å…¥å¾Œå°‡è‡ªå‹•é€²å…¥æˆ¿é–“");
  }
}

function login(){
  const acc = document.getElementById('account').value.trim();
  const pw = document.getElementById('password').value.trim();
  const name = document.getElementById('name').value.trim();
  if(!acc||!pw||!name){ alert('è«‹å®Œæ•´è¼¸å…¥'); return; }
  if(USER_ACCOUNTS[acc]!==pw){ alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); return; }

  localStorage.setItem('currentUser', name);
  document.getElementById('loginDiv').style.display='none';
  document.getElementById('roomDiv').style.display='block';
  loadRoomList();
  if(invitedRoom){ saveRoom(invitedRoom); openRoom(invitedRoom); }
}

function saveRoom(room){
  let rooms = JSON.parse(localStorage.getItem('rooms')||'[]');
  if(!rooms.includes(room)) rooms.push(room);
  localStorage.setItem('rooms', JSON.stringify(rooms));
}

function loadRoomList(){
  const rooms = JSON.parse(localStorage.getItem('rooms')||'[]');
  const listDiv = document.getElementById('roomList');
  listDiv.innerHTML='';
  rooms.forEach((r,index)=>{
    const div = document.createElement('div');
    const btn = document.createElement('button'); btn.textContent=r; btn.onclick=()=>joinRoom(r);
    const del = document.createElement('button'); del.textContent="âŒ"; del.style.marginLeft="10px";
    del.onclick=()=>{ rooms.splice(index,1); localStorage.setItem('rooms', JSON.stringify(rooms)); loadRoomList(); };
    div.appendChild(btn); div.appendChild(del); listDiv.appendChild(div);
  });
}

function createRoom(){
  const room = document.getElementById('roomName').value.trim();
  if(!room){ alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±'); return; }
  saveRoom(room); openRoom(room);
}

function joinRoom(room){
  const r = room || document.getElementById('roomName').value.trim();
  if(!r){ alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±'); return; }
  saveRoom(r); openRoom(r);
}

function callFriend(){
  const timestamp = new Date().getTime();
  const room = "call-" + timestamp; saveRoom(room); openRoom(room);
  const inviteLink = window.location.origin + window.location.pathname + "?room=" + encodeURIComponent(room);
  navigator.clipboard.writeText(inviteLink).then(()=>alert("è‡¨æ™‚æˆ¿é–“å·²å»ºç«‹ï¼é‚€è«‹é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼š\n"+inviteLink));
}

function openRoom(room){
  const name = localStorage.getItem('currentUser');
  const iframe = document.getElementById('chatRoom');
  iframe.style.display='block';
  document.getElementById('chatArea').style.display='block';
  const roomURL = `https://meet.jit.si/${encodeURIComponent(room)}#userInfo.displayName=${encodeURIComponent(name)}`;
  iframe.src = roomURL;
  alert("ğŸ“ æœ‰äººæ‰“ä¾†äº†ï¼æˆ¿é–“ï¼š" + room);
  const inviteLink = window.location.origin + window.location.pathname + "?room=" + encodeURIComponent(room);
  document.getElementById("inviteDiv").innerHTML = `ğŸ”— é‚€è«‹æœ‹å‹é€£çµï¼š<a href="${inviteLink}">${inviteLink}</a>`;
}

function sendMessage(){
  const input = document.getElementById('chatInput');
  if(input.value.trim()==='') return;
  const msg = document.createElement('div'); msg.textContent = localStorage.getItem('currentUser') + "ï¼š" + input.value;
  document.getElementById('messages').appendChild(msg); input.value='';
}

function toggleStickers(){
  const panel = document.getElementById('stickerPanel'); panel.style.display = panel.style.display==='none'?'block':'none';
}

function sendSticker(url){
  const msg = document.createElement('div'); const img = document.createElement('img');
  img.src=url; img.style.width='60px';
  msg.textContent=localStorage.getItem('currentUser')+"ï¼š"; msg.appendChild(img);
  document.getElementById('messages').appendChild(msg); toggleStickers();
}

function toggleFullscreen(){
  const chatArea = document.getElementById('chatArea');
  const videoContainer = document.getElementById('videoContainer');
  const btn = document.getElementById('fullscreenBtn');
  if(!isFullscreen){
    chatArea.style.display='none';
    videoContainer.style.flex='1';
    btn.textContent='é€€å‡ºå…¨è¢å¹•';
    isFullscreen=true;
  } else {
    chatArea.style.display='block';
    videoContainer.style.flex='1';
    btn.textContent='å…¨è¢å¹•';
    isFullscreen=false;
  }
}
</script>
</body>
</html>
